<!DOCTYPE html>
<html lang="en">
<head>
<title>csz</title>
<meta charset="utf-8" />
<meta name="description" content="look at me">

<!-- CSS -->
<style>
:root {
  --theme: #eee;
} html, body {
  margin: 0;
} body {
  line-height: 0;
  height: 100%;
  color: var(--theme);
  position: absolute;
  background: none;
} .content {
  opacity: 0.1;
  color: var(--theme-bg);
} .content:hover {
  opacity: 1;
} canvas {
  position: absolute;
  top: 0;
  left: 0;
  z-index: -1;
  color: var(--theme-bg);
  background: black;
} textarea {
  display: block;
  width: 100%;
  color: var(--theme);
} .mouse-tip {
  position: absolute;
  display: block;
} .mouse-tip div {
  line-height: 1rem;
  min-width: max-content;
} .hidden {
  display: none;
}
</style>

<!-- JS -->
<script type="module">
import { CSZ } from './src/csz.js'
window.onload = () => {
  const canvas = document.querySelector('#canvas')
  canvas.width = window.innerWidth
  canvas.height = window.innerHeight

  // config
  const fps = 60
  const tps = 1000
  const speedMultiplier = 0.001
  const gravityMultiplier = 0.1
  const centerGravityMultiplier = 0.000001

  // csz 
  var csz = new CSZ(canvas, fps, tps)
  window.csz = csz
  csz.engine.wrap = false
  csz.engine.spaceDepth = 0
  csz.engine.batchSize = 0 // number of particles to draw per frame

  // 0-1 sliders
  const sliders = {
    "SimulationSpeed": [csz.engine.speed, (val) => csz.engine.speed = Math.pow(val, 2) * speedMultiplier],
    "ParticleGravity": [csz.engine.antigravity, (val) => csz.engine.antigravity = val * gravityMultiplier],
  }

  // componets
  const fileInput = document.getElementById('fileInput')
  const slidersElem = document.getElementById('sliders')
  const colorColumns = [
    document.getElementById('redColumn'),
    document.getElementById('greenColumn'),
    document.getElementById('blueColumn')
  ]
  const nameElem = document.getElementById('name')

  // handle text embeddings
  const embeddingText = document.getElementById('embedding-text')
  const typeDelay = 200
  let lastTyped = 0
  let words = []
  const updateEmbedding = (event) => {
    // ignore if whitespace or newline added
    if (event.data && event.data.match(/\s/)) { csz.reset(); return }
    // embed text to csv
    const text = event.target.value.trim()
    if (!text) { return }
    words = text.split(/\s+/)
    csz.embed(text)
  }
  embeddingText.addEventListener('input', (event) => {
    const now = Date.now()
    if (now - lastTyped < typeDelay) { return }
    lastTyped = now
    setTimeout(updateEmbedding, typeDelay, event)
  })
  embeddingText.dispatchEvent(new Event('input'))

  // handle file imports
  fileInput.addEventListener('change', (event) => {
    csz.importCSV(event.target.files[0])
  })
  if (fileInput.value) { csz.importCSV(fileInput.files[0]) }

  // adjust sliders
  const sliderSteps = 1000
  for (let [key, [start, set]] of Object.entries(sliders)) {
    let group = document.createElement('p')
    group.innerHTML = `${key} <input type="range" id="${key}Slider" min="1" />`
    slidersElem.appendChild(group)
    // listen for changes
    let slider = document.getElementById(`${key}Slider`)
    slider.max = sliderSteps
    slider.value = localStorage.getItem(`${key}Slider`) || start * sliderSteps
    slider.addEventListener('input', (event) => {
      localStorage.setItem(`${key}Slider`, event.target.value)
      set(event.target.value / sliderSteps)
    })
    slider.dispatchEvent(new Event('input'))
  }

  // load example
  document.getElementById('sample').addEventListener('click', () => {
    // load file from url
    csz.importURL('examples/test_lowess_simple.csv')
  })

  // show particle data on hover
  const mouseTip = document.createElement('div')
  document.body.appendChild(mouseTip)
  mouseTip.classList.add('mouse-tip', 'hidden')
  document.addEventListener('mousemove', (event) => {
    //let clickX = event.clientX / canvas.width
    //let clickY = event.clientY / canvas.height
    let mouseX = event.clientX / canvas.width / csz.engine.screenFill % 1
    let mouseY = event.clientY / canvas.height / csz.engine.screenFill % 1
    // loop through particles to see if any has a distance less than 10
    let radius = 0.04 // in screen percentage
    let minDistance = radius
    let minIdx = -1
    for (let i=0; i<csz.engine.particles.length; i++) {
      const particle = csz.engine.particles[i]
      let distance = Math.sqrt(
        Math.pow(particle.x - mouseX, 2) +
        Math.pow(particle.y - mouseY, 2)
      )
      if (distance < minDistance) {
        minDistance = distance
        minIdx = i
      }
    }

    if (minIdx < 0 || minDistance > radius) {
      mouseTip.classList.add('hidden')
    } else {
      mouseTip.innerHTML = ''
      const particle = csz.engine.particles[minIdx]
      const word = words[minIdx]
      const addLabel = (value) => {
        const label = document.createElement('div')
        label.innerHTML = `${value}`
        mouseTip.appendChild(label)
      }
      //addLabel(`(${particle.x.toFixed(2)}, ${particle.y.toFixed(2)})`)
      addLabel(`${word}`)
      mouseTip.classList.remove('hidden')
      mouseTip.style.left = `${event.clientX + 10}px`
      mouseTip.style.top = `${event.clientY + 10}px`
    }
  })

  //
  // CSZ EVENTS

  csz.onUpdate = (data) => {
    // update project name
    nameElem.innerHTML = data.name
  }

  csz.onReady = () => {
    // color mapping (create options) 
    for (let elem of colorColumns) {
      elem.innerHTML = '' // reset options
      for (let column of csz.dimensions) {
        let option = document.createElement('option')
        option.value = column
        option.innerHTML = column
        elem.appendChild(option)
      }
    }
    // map colors
    for (let i = 0; i < colorColumns.length; i++) {
      let elem = colorColumns[i]
      // update color mapping
      elem.addEventListener('change', (event) => {
        let column = event.target.value
        if (column == '') { return }
        csz.colorColumn(column, i)
      })
      // map selected value to column
      elem.selectedIndex = i
      elem.dispatchEvent(new Event('change'))
    }

    // start csz 
    csz.run()
  }
}
</script>
</head>

<!-- HTML -->
<body>
  <div class="content">
    <h1>csz</h1>
    <h2 id="name">
      <h3>see <a href="https://dot.leonk.dev">dot</a></h3>
    </h2>
    <textarea id="embedding-text"></textarea>
    <input type="button" id="sample" value="Load example" />
    <input type="file" id="fileInput" />
    <div id="sliders"></div>
    <p>Red <select id="redColumn"></select></p>
    <p>Green <select id="greenColumn"></select></p>
    <p>Blue <select id="blueColumn"></select></p>
  </div>
  <canvas id="canvas"></canvas>
</body>
<html>
